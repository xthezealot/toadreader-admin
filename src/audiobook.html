<script>
    const token = localStorage.getItem("token")

    Alpine.data("audiobook", () => ({
        id: null,
        title: "",
        author: null,
        existentCover: null,
        coverFile: null,
        chapters: [],

        async init() {
            await this.loadAudiobook()
        },

        async loadAudiobook() {
            try {
                const paramsStr = location.hash.includes("?") ? location.hash.split("?")[1] : ""
                const params = new URLSearchParams(paramsStr)
                const idStr = params.get("id")

                // no id provided: treat as new audiobook (skip fetch)
                if (!idStr) return

                // fetch audiobook
                const response = await fetch(`http://localhost:4567/audiobooks/${idStr}`, {
                    headers: { Authorization: `Bearer ${token}` }
                })

                if (response.ok) {
                    const audiobook = await response.json()
                    this.id = audiobook.id
                    this.title = audiobook.title
                    this.author = audiobook.author
                    this.existentCover = audiobook.cover
                    this.chapters = audiobook.chapters
                } else {
                    console.error("Failed to load audiobook")
                }
            } catch (error) {
                console.error("Network error:", error)
            }
        },

        get coverUrl() {
            if (this.coverFile) return URL.createObjectURL(this.coverFile)
            return this.existentCover ? `http://localhost:4567/storage/${this.existentCover}` : null
        },

        renderChapter(chapter) {
            if (chapter.children && chapter.children.length > 0) {
                // section with children
                const childrenHtml = chapter.children.map(child => this.renderChapter(child)).join("")
                return `<li><div><div class="section-title">${chapter.title}</div><ul>${childrenHtml}</ul></div></li>`
            } else {
                // clickable chapter
                const clickable = chapter.file ? "clickable" : ""
                return `<li><div class="chapter-title ${clickable}">${chapter.title}</div></li>`
            }
        },

        async saveAudiobook(event) {
            try {
                const formData = new FormData(event.target)
                // cover
                if (this.coverFile) formData.set("cover", this.coverFile)
                else if (this.existentCover) formData.set("cover", this.existentCover)
                else formData.set("cover", null)
                // chapters
                formData.append("chapters", JSON.stringify(this.chapters))

                const response = await fetch(`http://localhost:4567/audiobooks${this.id ? `/${this.id}` : ""}`, {
                    method: this.id ? "PUT" : "POST",
                    headers: { Authorization: `Bearer ${token}` },
                    body: formData,
                })

                if (response.ok) {
                    console.log("Audiobook saved successfully")
                    location.hash = "audiobooks.html"
                } else {
                    console.error("Failed to save audiobook", response)
                }
            } catch (error) {
                console.error("Network error:", error)
            }
        }
    }))
</script>


<style>
    .cover-preview {
        max-width: 300px;
        max-height: 300px;
        box-shadow: 0 0 1em rgba(0, 0, 0, 0.1);
        border-radius: 1rem;
    }
</style>


<div x-data="audiobook">
    <dashboard-shell :title="title">
        <form @submit.prevent="saveAudiobook">
            <!-- cover -->
            <template x-if="coverUrl">
                <img class="cover-preview" :src="coverUrl" />
            </template>

            <div>
                <input type="file" name="cover" @change="coverFile = $event.target.files[0]" accept="image/*">
            </div>

            <!-- title and author -->
            <div>
                <input type="text" name="title" x-model="title" placeholder="Title" required></input>
            </div>
            <div>
                <input type="text" name="author" x-model="author" placeholder="Author"></input>
            </div>

            <div id="chapters">
                <h2 class="title">Chapters</h2>
                <!-- recursive chapters list -->
                <ul x-html="chapters?.map(chapter => renderChapter(chapter)).join('') || ''"></ul>
            </div>

            <button type="submit">Save</button>
        </form>
    </dashboard-shell>
</div>
