<script>
    const token = localStorage.getItem("token")

    Alpine.data("audiobook", () => ({
        id: null,
        title: "",
        author: null,
        existentCover: null,
        coverFile: null,
        chapters: [],


        async init() {
            await this.loadAudiobook()
        },


        async loadAudiobook() {
            try {
                const paramsStr = location.hash.includes("?") ? location.hash.split("?")[1] : ""
                const params = new URLSearchParams(paramsStr)
                const idStr = params.get("id")

                // no id provided: treat as new audiobook (skip fetch)
                if (!idStr) return

                // fetch audiobook
                const response = await fetch(`http://localhost:4567/audiobooks/${idStr}`, {
                    headers: { Authorization: `Bearer ${token}` }
                })

                if (response.ok) {
                    const audiobook = await response.json()
                    this.id = audiobook.id
                    this.title = audiobook.title
                    this.author = audiobook.author
                    this.existentCover = audiobook.cover
                    this.chapters = this.normalizeChapters(audiobook.chapters)
                } else {
                    console.error("Failed to load audiobook")
                }
            } catch (error) {
                console.error("Network error:", error)
            }
        },


        generateChapterKey() {
            return `ch-${Math.random().toString(36).slice(2, 10)}`
        },


        normalizeChapters(list) {
            if (!Array.isArray(list)) return []
            return list.map(chapter => {
                const normalized = { ...(chapter || {}) }
                normalized.oldFile = chapter?.file ?? chapter?.oldFile ?? null
                delete normalized.file
                normalized.children = this.normalizeChapters(chapter.children)
                normalized._key = chapter?.id != null ? `id-${chapter.id}` : (chapter?._key || this.generateChapterKey())
                return normalized
            })
        },


        createEmptyChapter(title = "New chapter") {
            return {
                title,
                oldFile: null,
                children: [],
                _key: this.generateChapterKey()
            }
        },


        serializeChapters(root, formData) {
            if (!root) return []
            const items = Array.from(root.children).filter(el => el.tagName === "LI")
            return items.map(item => {
                const chapter = {}
                const titleInput = item.querySelector('input[name="title"]')
                chapter.title = titleInput ? titleInput.value : ""
                const newFileInput = item.querySelector('input[name="newFile"]')
                const oldFileInput = item.querySelector('input[name="oldFile"]')
                const file = newFileInput?.files?.[0] || null
                if (file) {
                    const ext = file.name.includes('.') ? `.${file.name.split('.').pop()}` : ""
                    const filename = `${this.generateChapterKey()}${ext}`
                    formData.set(filename, file)
                    chapter.file = filename
                } else if (oldFileInput?.value) {
                    chapter.file = oldFileInput.value
                }
                const childList = Array.from(item.children).find(el => el.tagName === "UL") || null
                const children = this.serializeChapters(childList, formData)
                if (children.length) chapter.children = children
                return chapter
            })
        },


        get coverUrl() {
            if (this.coverFile) return URL.createObjectURL(this.coverFile)
            return this.existentCover ? `http://localhost:4567/storage/${this.existentCover}` : null
        },


        async saveAudiobook(event) {
            try {
                const formData = new FormData()
                formData.set("title", this.title ?? "")
                formData.set("author", this.author ?? "")
                // cover
                if (this.coverFile) formData.set("cover", this.coverFile)
                else if (this.existentCover) formData.set("cover", this.existentCover)
                else formData.set("cover", null)
                // chapters
                const chaptersRoot = this.$el.querySelector("#chapters > ul")
                const chapters = this.serializeChapters(chaptersRoot, formData)
                formData.set("chapters", JSON.stringify(chapters))

                const response = await fetch(`http://localhost:4567/audiobooks${this.id ? `/${this.id}` : ""}`, {
                    method: this.id ? "PUT" : "POST",
                    headers: { Authorization: `Bearer ${token}` },
                    body: formData,
                })

                if (response.ok) {
                    console.log("Audiobook saved successfully")
                    location.hash = "audiobooks.html"
                } else {
                    console.error("Failed to save audiobook", response)
                }
            } catch (error) {
                console.error("Network error:", error)
            }
        },
    }))
</script>


<style>
    .cover-preview {
        max-width: 300px;
        max-height: 300px;
        box-shadow: 0 0 1em rgba(0, 0, 0, 0.1);
        border-radius: 1rem;
    }

    /* Chapter lists styling */
    #chapters {
        ul {
            list-style: none;
            padding-bottom: 1rem;
            padding-left: 1rem;

            li {
                cursor: move;
                background: rgba(52, 58, 64, .05);
                border-radius: .5rem;
                padding: .5rem 1rem;

                & + li {
                    margin-top: .5rem;
                }

                & > div {
                    margin-bottom: .5rem;
                }
            }
        }

        & > div > ul {
            padding-left: 0;
        }
    }
</style>


<div x-data="audiobook" @setChaptersFromDom.window="setChaptersFromDom">
    <dashboard-shell :title="title">
        <form @submit.prevent="saveAudiobook">
            <!-- cover -->
            <template x-if="coverUrl">
                <img class="cover-preview" :src="coverUrl" />
            </template>

            <div>
                <input type="file" name="cover" @change="coverFile = $event.target.files[0]" accept="image/*">
            </div>

            <!-- title and author -->
            <div>
                <input type="text" name="title" x-model="title" placeholder="Title" required></input>
            </div>
            <div>
                <input type="text" name="author" x-model="author" placeholder="Author"></input>
            </div>

            <div id="chapters">
                <h2 class="title">Chapters</h2>
                <div style="margin: .5rem 0">
                    <button type="button" @click="chapters.push(createEmptyChapter())">Add chapter</button>
                </div>
                <ul x-sort="chapters" group="chapters" x-sort:group="chapters">
                    <template x-for="chapterL1 in chapters" :key="chapterL1._key">
                        <li x-sort:item="chapterL1">
                            <div x-data="{ chapter: chapterL1, audioPreview: chapterL1.oldFile ? 'http://localhost:4567/storage/' + chapterL1.oldFile : null }">
                                <input type="text" name="title" x-model="chapter.title">
                                <input type="text" name="oldFile" x-model="chapter.oldFile" disabled>
                                <input type="file" name="newFile" @change="const file = $event.target.files[0] || null; audioPreview = file ? URL.createObjectURL(file) : (chapter.oldFile ? 'http://localhost:4567/storage/' + chapter.oldFile : null)">
                                <audio controls x-show="audioPreview" :src="audioPreview"></audio>
                            </div>
                            <ul x-sort="chapterL1.children" group="chapters" x-sort:group="chapters">
                                <template x-for="chapterL2 in chapterL1.children" :key="chapterL2._key">
                                    <li x-sort:item="chapterL2">
                                        <div x-data="{ chapter: chapterL2, audioPreview: chapterL2.oldFile ? 'http://localhost:4567/storage/' + chapterL2.oldFile : null }">
                                            <input type="text" name="title" x-model="chapter.title">
                                            <input type="text" name="oldFile" x-model="chapter.oldFile" disabled>
                                            <input type="file" name="newFile" @change="const file = $event.target.files[0] || null; audioPreview = file ? URL.createObjectURL(file) : (chapter.oldFile ? 'http://localhost:4567/storage/' + chapter.oldFile : null)">
                                            <audio controls x-show="audioPreview" :src="audioPreview"></audio>
                                        </div>
                                        <ul x-sort="chapterL2.children" group="chapters" x-sort:group="chapters">
                                            <template x-for="chapterL3 in chapterL2.children" :key="chapterL3._key">
                                                <li x-sort:item="chapterL3">
                                                    <div x-data="{ chapter: chapterL3, audioPreview: chapterL3.oldFile ? 'http://localhost:4567/storage/' + chapterL3.oldFile : null }">
                                                        <input type="text" name="title" x-model="chapter.title">
                                                        <input type="text" name="oldFile" x-model="chapter.oldFile" disabled>
                                                        <input type="file" name="newFile" @change="const file = $event.target.files[0] || null; audioPreview = file ? URL.createObjectURL(file) : (chapter.oldFile ? 'http://localhost:4567/storage/' + chapter.oldFile : null)">
                                                        <audio controls x-show="audioPreview" :src="audioPreview"></audio>
                                                    </div>
                                                </li>
                                            </template>
                                        </ul>
                                    </li>
                                </template>
                            </ul>
                        </li>
                    </template>
                </ul>
            </div>

            <pre x-text="JSON.stringify(chapters, null, 2)"></pre>

            <button type="submit">Save</button>
        </form>
    </dashboard-shell>
</div>
